# Instructions pour Claude - Projet CRM Expert Judiciaire

## Principe fondamental
Ne JAMAIS considérer une tâche comme terminée tant que le flux complet n'est pas vérifié.

---

## 1. Flux de données complet (OBLIGATOIRE)

Pour TOUTE modification de données, vérifier ces 5 étapes :

| Étape | Question à se poser |
|-------|---------------------|
| **SOURCE** | D'où viennent les données ? (localStorage, API, état React, props) |
| **LECTURE** | Comment sont-elles lues ? (quelle fonction, quel hook) |
| **MODIFICATION** | Comment sont-elles modifiées ? |
| **SAUVEGARDE** | Où sont-elles sauvegardées ? (même endroit que la source !) |
| **RAFRAÎCHISSEMENT** | L'UI se met-elle à jour après sauvegarde ? |

### Exemple de vérification :
```
Ajout d'une partie :
- SOURCE: getStoredAffaires() → localStorage OU DEMO_AFFAIRES
- LECTURE: useAffaires() hook
- MODIFICATION: affaires[index].parties.push(newPartie)
- SAUVEGARDE: saveAffaires() → localStorage ✓
- RAFRAÎCHISSEMENT: window.location.reload() OU refetch() ✓
```

---

## 2. Boutons et actions (TOUT connecter)

Quand on demande de "rendre un bouton fonctionnel", cela inclut OBLIGATOIREMENT :

- [ ] Le bouton a un onClick qui déclenche une action
- [ ] L'action ouvre un formulaire/modal si nécessaire
- [ ] Le formulaire a tous les champs requis
- [ ] Le formulaire a une validation (required, types)
- [ ] La soumission appelle une fonction de sauvegarde
- [ ] La sauvegarde utilise les bonnes fonctions (getStoredAffaires/saveAffaires)
- [ ] Après sauvegarde, le modal se ferme
- [ ] Après sauvegarde, les données sont visibles dans l'UI
- [ ] Les données persistent après rechargement de page
- [ ] Les éléments connexes sont aussi mis à jour (compteurs, badges, listes)

---

## 3. Éléments connexes (TOUJOURS vérifier)

Quand je modifie un élément, vérifier TOUS ses impacts :

| Si je modifie... | Vérifier aussi... |
|------------------|-------------------|
| Liste des parties | Compteur "X parties", onglet parties, sélecteurs de parties dans dires/matrice |
| Liste des réunions | Calendrier, "prochaine réunion" sur dashboard, badges de statut, convocations |
| Liste des désordres | Module chiffrage (liaison désordre), rapport, matrice d'imputabilité |
| Données financières | Totaux HT/TTC, graphiques, état des provisions, solde |
| Statut d'affaire | Dashboard stats, filtres, badges, indicateurs d'avancement |
| Documents | Liste documents, téléchargements, pièces jointes rapport |

---

## 4. Patterns existants (RÉUTILISER absolument)

Avant de créer du nouveau code :

### 4.1 Fonctions de données (MODE DÉMO)
```javascript
// TOUJOURS utiliser ces fonctions, JAMAIS localStorage direct
import { getStoredAffaires, saveAffaires } from '../../lib/demoData';

// Lecture
const affaires = getStoredAffaires(); // Retourne DEMO_AFFAIRES si localStorage vide

// Sauvegarde
saveAffaires(affaires);
```

### 4.2 Composants UI
```javascript
import { Card, Badge, Button, Input, Select, ModalBase, EmptyState } from '../ui';
```

### 4.3 Structure d'un modal fonctionnel
```javascript
const ModalExample = ({ affaireId, onClose, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState({ /* champs */ });

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const affaires = getStoredAffaires();
      const index = affaires.findIndex(a => a.id === affaireId);
      if (index !== -1) {
        // Modifier les données
        affaires[index].xxx.push(newItem);
        saveAffaires(affaires);
        onSuccess(); // Ferme modal + rafraîchit
      }
    } catch (error) {
      console.error('Erreur:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <ModalBase isOpen={true} onClose={onClose} title="Titre">
      <form onSubmit={handleSubmit}>
        {/* Champs */}
        <Button type="submit" loading={loading}>Valider</Button>
      </form>
    </ModalBase>
  );
};
```

---

## 5. Mode démo - Règles spéciales

Ce projet fonctionne SANS backend (Supabase non configuré).

### Règles strictes :
1. **TOUJOURS** utiliser `getStoredAffaires()` au lieu de `localStorage.getItem()` direct
2. **TOUJOURS** utiliser `saveAffaires()` pour sauvegarder
3. Les données initiales viennent de `DEMO_AFFAIRES` (src/lib/demoData.js) si localStorage vide
4. Après sauvegarde, faire `window.location.reload()` ou appeler le refetch du hook

### Pourquoi ?
```javascript
// MAUVAIS - Ne fonctionne pas si localStorage vide
const stored = localStorage.getItem('crm_demo_affaires');
if (stored) { // NULL si jamais sauvegardé → code ignoré !
  // ...
}

// BON - Fonctionne toujours
const affaires = getStoredAffaires(); // Retourne DEMO_AFFAIRES si vide
```

---

## 6. Checklist avant de dire "c'est fait"

### Vérification technique
- [ ] J'ai tracé le flux complet SOURCE → LECTURE → MODIFICATION → SAUVEGARDE → RAFRAÎCHISSEMENT
- [ ] J'ai vérifié que la source et la destination des données sont cohérentes
- [ ] J'ai utilisé getStoredAffaires/saveAffaires (pas localStorage direct)
- [ ] J'ai vérifié les éléments connexes qui doivent se mettre à jour
- [ ] J'ai utilisé les composants UI existants (ModalBase, Input, Select, Button)
- [ ] Le code compile sans erreur (`npm run build`)

### Documentation pour l'utilisateur
- [ ] J'ai décrit le parcours utilisateur pour tester
- [ ] J'ai listé les résultats attendus à chaque étape
- [ ] J'ai indiqué comment vérifier la persistance (reload)

---

## 7. Ce que Claude ne peut PAS faire

| Limitation | Conséquence |
|------------|-------------|
| Tester visuellement l'application | Doit EXPLIQUER comment tester |
| Cliquer sur les boutons | Doit DÉCRIRE le parcours utilisateur |
| Voir si l'UI se met à jour | Doit VÉRIFIER le code de rafraîchissement |
| Détecter les erreurs silencieuses | Doit ÉVITER les catch vides, ajouter des console.error |
| Garder mémoire entre sessions | Doit RELIRE ce fichier à chaque nouvelle conversation |

---

## 8. Format de réponse après modification

Après chaque modification, fournir ce résumé :

```markdown
## Modification effectuée
[Description courte]

## Flux de données vérifié
- SOURCE: [d'où viennent les données]
- LECTURE: [comment elles sont lues]
- MODIFICATION: [ce qui change]
- SAUVEGARDE: [où elles vont]
- RAFRAÎCHISSEMENT: [comment l'UI se met à jour]

## Éléments connexes vérifiés
- [x] Élément 1 - impact vérifié
- [x] Élément 2 - impact vérifié
- [ ] Élément 3 - non impacté

## Pour tester
1. Aller sur [page/URL]
2. Cliquer sur [bouton]
3. Remplir [champs du formulaire]
4. Cliquer sur [bouton validation]
5. **Vérifier** : [résultat attendu visible]
6. **Recharger** la page (F5)
7. **Vérifier** : [données toujours présentes]

## Fichiers modifiés
- `src/xxx/yyy.jsx` : [description changement]
```

---

## 9. Commandes utiles

```bash
# Vérifier que le code compile
npm run build

# Lancer en développement
npm run dev

# Le serveur tourne sur http://localhost:3000/crm-expert-judiciaire/
```

---

## 10. Structure des données principales

### Affaire
```javascript
{
  id: 'xxx',
  reference: 'EXP-2024-0001',
  rg: '24/01234',
  tribunal: 'TJ Paris',
  statut: 'en-cours', // 'nouveau', 'en-cours', 'rapport', 'cloture'
  parties: [...],      // → TabParties, sélecteurs, dires
  reunions: [...],     // → TabReunions, calendrier
  pathologies: [...],  // → TabDesordres, chiffrage, rapport
  documents: [...],    // → TabDocuments
  vacations: [...],    // → TabFinancier
  frais: [...],        // → TabFinancier
  dires: [...]         // → GestionDires
}
```

### Partie
```javascript
{
  id: 'partie-xxx',
  type: 'demandeur', // 'demandeur', 'defenseur', 'intervenant', 'assureur'
  nom: 'DUPONT',
  prenom: 'Jean',
  raison_sociale: '', // Si entreprise
  role: 'Propriétaire',
  email: '',
  telephone: '',
  avocat_nom: '',
  avocat_email: ''
}
```

### Réunion
```javascript
{
  id: 'reunion-xxx',
  numero: 1,
  date_reunion: '2024-02-10T09:00:00',
  lieu: 'Adresse',
  type: 'expertise', // 'expertise', 'contradictoire', 'technique', 'finale'
  statut: 'planifiee', // 'planifiee', 'terminee', 'annulee'
  duree_prevue: 120, // minutes
  compte_rendu: ''
}
```

### Désordre/Pathologie
```javascript
{
  id: 'patho-xxx',
  numero: 1,
  intitule: 'Fissures structurelles',
  localisation: 'Mur porteur salon',
  description: 'Description détaillée...',
  gravite: 'majeure', // 'mineure', 'moyenne', 'majeure', 'critique'
  garantie: 'decennale', // 'gpa', 'biennale', 'decennale', 'hors_garantie'
  cause_presumee: ''
}
```
